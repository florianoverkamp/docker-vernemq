#!/bin/bash

SELF_IP="127.0.0.1"
LISTEN_IP="0.0.0.0"
MIN_NODES_SIZE="${MIN_NODES_SIZE:-3}"
SSL_AUTH="${SSL_AUTH:-"no"}"
SSL_CA="${SSL_CA:-"/run/secrets/mqtt_ca_cert"}"
SSL_CERT="${SSL_CERT:-"/run/secrets/mqtt_server_cert"}"
SSL_KEY="${SSL_KEY:-"/run/secrets/mqtt_server_key"}"
DISCOVERY_NAME="${DISCOVERY_NAME:-"tasks.$SERVICE_NAME"}"
if [[ "$SSL_AUTH" == "yes" ]]; then
  export SSL_AUTH
fi
if [[ -n "$SERVICE_NAME" ]]; then
  echo "service name given: $SERVICE_NAME - we are running in cluster mode"
  # wait for all nodes to appear
  SELF_IP=""
  number_of_nodes=1
  while [[ "$SELF_IP" == "" ]]; do
    SELF_IP=$(dig +short $(hostname))
    sleep 1
  done
  while [[ $number_of_nodes -lt ${MIN_NODES_SIZE} ]]; do
    sleep 1
    NODES=$(dig +short ${DISCOVERY_NAME})
    number_of_nodes=$(( $(echo $NODES | grep -o '\s' | wc -l) + 1 )) >/dev/null
    echo "we found $number_of_nodes nodes behind '${DISCOVERY_NAME}'"
  done
  echo "self ip: $SELF_IP"
  echo "peer nodes: $NODES"
fi
export SELF_IP
export LISTEN_IP
render.py /etc/vernemq/vernemq.conf.j2 > /etc/vernemq/vernemq.conf
/usr/share/vernemq/bin/vernemq config generate | grep error
if [ $? -ne 1 ]; then
    echo "configuration error, exit"
    echo "$(cat /usr/share/vernemq/bin/../etc/vernemq.conf)"
    exit 1
fi
echo running /usr/share/vernemq/bin/vernemq start
/usr/share/vernemq/bin/vernemq start
output=""
echo -n "waiting for node to finish booting"
while [[ "$output" != "pong" ]]; do
  echo -n "."
  sleep 0.1
  output=$(/usr/share/vernemq/bin/vernemq ping)
done
echo "done"
pid=$(ps aux | grep '[b]eam.smp' | awk '{print $1}')
echo $pid > /var/run/vernemq.pid


# SIGTERM-handler
# https://github.com/erlio/docker-vernemq/blob/master/bin/vernemq.sh
sigterm_handler() {
    echo caught SIGTERM
    if [ $pid -ne 0 ]; then
        echo starting shutdown
        # this will stop the VerneMQ process
        /usr/share/vernemq/bin/vmq-admin cluster leave node=VerneMQ@$SELF_IP -t 20
        /usr/share/vernemq/bin/vmq-admin cluster leave node=VerneMQ@$SELF_IP -k
        sleep 10
    fi
    exit 143; # 128 + 15 -- SIGTERM
}


for node in ${NODES}; do
  echo "trying to join node $node"
  /usr/share/vernemq/bin/vmq-admin cluster join discovery-node=VerneMQ@$node
done

echo "config:"
cat /etc/vernemq/vernemq.conf | while read line; do echo -e "\t$line"; done
trap 'kill $!; sigterm_handler' 15
tail -F /var/log/vernemq/*.log &
wait $!
